# Show Me The Way
## Author: Chelinka

## Source

- The secret agent 007 gave us a classified file and gave us the means to read it, unfortunately, he could not do it to avoid any suspicion within the Hack107. Decrypt the text in the file to read the flag!
- Download the files and get the flag data ! FLAG FORMAT : HACKDAY{PROTOCOL}

### Files: 
- encrypt.py
- secretmessage.txt

## Encryption

- Lets break down the 'encrypt.py' file
```
from Crypto.Util.number import long_to_bytes,bytes_to_long

def P(x):
	return formula(x)
def Q(x):
	return another_formula(x)
```
- Two ambiguous functions P(x) and Q(x) are being used to generate the primes p and q.

```
n = P(X)*Q(X)
phi = (P(X)-1)*(Q(X)-1)
e = 0x10001
d = pow(e, -1, phi)

print(n)
def encrypt(pt:str, e, n):
	pt = pt[::-1]
	ct = pow(bytes_to_long(pt.encode()), e, n)
	return ct

def decrypt(ct:int, d, n):
	pt = pow(ct, d, n)
	pt = long_to_bytes(pt).decode()
	return pt[::-1]

flag = input("Que souhaitez-vous chiffrer ? ")
print(encrypt(flag, e, n))
```
- The rest is regular RSA encryption except the plaintext is getting reversed before getting encrypted.

## Decryption

- We do not know any info about how the primes were generated. There is just information that, a variable `X` has been passed to `P()` and `Q()` to get the primes.
- The only hint is that the number of the Agent is 007, so it can be a fair assumption that `X` is 7 
- So we can say `N = N(x) = P(x)*Q(x)`, where `N(x), P(x), Q(x)` are polynomials.
- Assuming X to be 7, we can find a polynomial `N(x)` by converting N to base 7.

```
from sage.all import *
from Crypto.Util.number import *

C = 2565617200166195847141820928636232303959466722932792435323711473965652085371699818644409256990409854048944273889028395427212647285096620147927751484918108065303000987005428811601509106033544824154004155247749651849388960745201851220865639078232468837572017487899553302561947972350180790337323260039010564873086627329116972503791322926648544263487729211803983796460777700080964480684225095759331029591580667172315329031801221006095830894913366492646106198809678335180404967834014465213071012334463161243798668249316387388896615356529679219334762683987621996735445923292411584267482736997931521981371010250736803883850124086811981296847046184646544341090182005804326034206846831836495437948287344937128613750220151417179776923247572197141730803872869207722489892434431306177467240055054918472090059029917750015977990019074665525769825707485580566711901744843592821082242610459526779285285457758540532197630815918118376169006356119855487579630979321639934789282013802634090104249954889447300640494797136454210084024870216383477122432977329939795881446508639802099815243215786621936463817640047721308586018053015489260037207134192787282389359286090040755235606024014221310785716415247412510214122721056658870318538556573512692
N = 10274622173320909389031395002382723520310683266624262003758324433654540040809219233599998390391541291081480955769558063877739745263628876566148594399190487217520529947703418385797126076202883896285563297412493796455549735516349258737267111485734958124647676862139978578822328063131028977645973314255958832814431129401741363681924246624731580306332996274947224225276913011825249480579351788647303424376829926794897238480915821396590836505557261932201793218787876369479689474390699568395442160695951675495911526788768792712587827140759752600815834201530200102574327547287838813124748635529299343877238787638666002517369183147324348276580386835912162978347500880951405211071469315569907393288673767750500338439908319636060342999154216171420367334387728243762904978917643239586128408102087398429687219613116999755320251996795637299545734755393100528238070409625880097215206538255250563512463977488434914174814989014820102387306536769608806232340706951978003787459755560489338182409731880347246492232556511479625859446872995332197943657987872417697758505073815646447821621770469326686335161275436219144215858159910848423968589115317782429522873529296494028537507162631866445206682695650087594304263021619605307406513658218147729
e = 0x10001

x = PolynomialRing(RationalField(), 'x').gen()
poly = 0

N_temp = N
count = 0
while N_temp:
    digit = N_temp%7
    if digit:
        poly = poly + digit*x**count
    count+=1
    N_temp//=7

print(poly)
```
- Here we are only adding those terms to the polynomial where the digit of base 7 is non-zero.
- ex: `4032 in base 7 : 2+3*7+4*343 = 2 + 3*x + 4*x**3`

```
(P,_),(Q,_)=poly.factor()
print(P,Q,sep='\n')

p = P(7)
q = Q(7)
phi = (p-1)*(q-1)
```
- Then we factorise this polynomial into `P(x) and Q(x)`
- Now we get the primes `p and q` from `P(x) and Q(x)`
- After which its just regular RSA decryption

```
def binpow(a,b,mod):
    ans = 1
    while b:
        if b&1:
            ans = (ans*a)%mod
        b//=2
        a*=a
    return ans

d = pow(int(e),int(-1),int(phi))
m = pow(C,d,N)
print(long_to_bytes(m)[::-1])
```
- Just reverse the plaintext back after decrypting

### Output

```
x^1446 + 3*x^1198 + x^1146 + 3*x^898 + x^835 + x^790 + x^774 + x^724 + 2*x^723 + 3*x^542 + x^535 + 3*x^476 + 3*x^475 + x^474 + x^423 + x^179 + x^118 + x^113 + x^112 + x^67 + x^52 + x^51 + x + 1
x^723 + x^423 + x^67 + x + 1
x^723 + 3*x^475 + x^112 + x^51 + 1
b'DS Bandit pwned - Follow protocol EVE - Brute Ninja'
```

## Flag

The flag is `HACKDAY{EVE}`